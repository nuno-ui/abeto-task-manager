const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = 'https://pyxjwtyvmbltscayabsj.supabase.co';
const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5eGp3dHl2bWJsdHNjYXlhYnNqIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDIzMjAzOSwiZXhwIjoyMDg1ODA4MDM5fQ.4CO0_gKZQrmKWolIzcb-vuGmKNQAdLVKjIwRXTbd0JQ';

const supabase = createClient(supabaseUrl, serviceRoleKey);

// All tasks with full COO-level detail
const allProjectTasks = {
  'unified-data-layer': [
    {
      title: 'Data Audit & Gap Analysis',
      description: 'Audit all existing data sources (Zoho, Woztell, Aircall, Holded). Document current data flows, identify gaps, inconsistencies, and missing fields. Create data dictionary.',
      phase: 'discovery',
      owner: 'technology',
      estimated_hours: '16-24h',
      difficulty: 'medium',
      ai_potential: 'medium',
      ai_assist_description: 'Can help analyze data schemas and generate documentation templates',
      tools_needed: ['Notion', 'Spreadsheets', 'Existing system access'],
      knowledge_areas: ['Data Analytics', 'Business Logic'],
      acceptance_criteria: ['Complete inventory of all data sources', 'Data dictionary with field definitions', 'Gap analysis document with prioritized missing data', 'Data flow diagrams for current state'],
      success_metrics: ['100% of data sources documented', 'All critical gaps identified'],
      risks: ['Access delays to production systems', 'Undocumented legacy data'],
      is_foundational: true,
      is_critical_path: true,
      order_index: 0,
    },
    {
      title: 'Stakeholder Requirements Workshop',
      description: 'Conduct workshops with Sales, Ops, Finance, and Leadership to understand data needs. Document use cases, reporting requirements, and pain points.',
      phase: 'discovery',
      owner: 'operations',
      estimated_hours: '8-12h',
      difficulty: 'easy',
      ai_potential: 'low',
      ai_assist_description: 'Can help structure workshop agenda and document outputs',
      tools_needed: ['Meeting tools', 'Notion', 'Whiteboard'],
      knowledge_areas: ['Stakeholder Management', 'Business Logic'],
      acceptance_criteria: ['Workshop conducted with all key stakeholders', 'Requirements document approved by stakeholders', 'Priority ranking of data needs', 'Success criteria defined for each use case'],
      success_metrics: [],
      risks: ['Stakeholder availability', 'Conflicting requirements'],
      is_foundational: false,
      is_critical_path: true,
      order_index: 1,
    },
    {
      title: 'API Architecture Design',
      description: 'Design API architecture including endpoints, authentication, rate limiting, caching strategy. Define data models and relationships. Create technical specification document.',
      phase: 'planning',
      owner: 'technology',
      estimated_hours: '20-30h',
      difficulty: 'hard',
      ai_potential: 'high',
      ai_assist_description: 'Can generate OpenAPI specs, data models, and architecture diagrams',
      tools_needed: ['Architecture tools', 'Documentation'],
      knowledge_areas: ['API Integration', 'Database/SQL', 'Security/Auth'],
      acceptance_criteria: ['OpenAPI specification document', 'Database schema design', 'Authentication flow documented', 'Caching strategy defined', 'Rate limiting rules specified'],
      success_metrics: [],
      risks: [],
      is_foundational: true,
      is_critical_path: true,
      order_index: 2,
    },
    {
      title: 'Third-Party API Access & Contracts',
      description: 'Secure API access and documentation for all third-party systems. Negotiate contracts if needed. Document API limits, costs, and SLAs.',
      phase: 'planning',
      owner: 'operations',
      estimated_hours: '8-16h',
      difficulty: 'medium',
      ai_potential: 'low',
      ai_assist_description: 'Vendor negotiation requires human judgment',
      tools_needed: ['Contract management', 'Vendor portals'],
      knowledge_areas: ['Vendor Management', 'Compliance/Legal'],
      acceptance_criteria: ['Zoho API access confirmed with documented limits', 'Woztell API access and documentation obtained', 'Aircall API credentials and documentation', 'Holded API access for financial data', 'All API rate limits and costs documented'],
      success_metrics: [],
      risks: ['Vendor delays', 'Unexpected costs', 'API limitations'],
      is_foundational: false,
      is_critical_path: false,
      order_index: 3,
    },
    {
      title: 'Core API Infrastructure Setup',
      description: 'Set up API server, database, authentication system, logging, and monitoring. Deploy to staging environment.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '24-32h',
      difficulty: 'hard',
      ai_potential: 'high',
      ai_assist_description: 'Can generate boilerplate code, database migrations, and deployment configs',
      tools_needed: ['Node.js', 'PostgreSQL', 'Vercel/Railway', 'Auth0/JWT'],
      knowledge_areas: ['API Integration', 'Database/SQL', 'DevOps', 'Security/Auth'],
      acceptance_criteria: ['API server running in staging', 'Database deployed and accessible', 'Authentication system working', 'Logging and monitoring active', 'CI/CD pipeline configured'],
      success_metrics: [],
      risks: [],
      is_foundational: true,
      is_critical_path: true,
      order_index: 4,
    },
    {
      title: 'Deals & Opportunities Endpoints',
      description: 'Build endpoints for Deals and Opportunities including CRUD operations, filtering, pagination, and Zoho sync.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '20-28h',
      difficulty: 'medium',
      ai_potential: 'high',
      ai_assist_description: 'Can generate CRUD endpoints, data models, and sync logic',
      tools_needed: ['Node.js', 'PostgreSQL', 'Zoho API'],
      knowledge_areas: ['API Integration', 'Database/SQL'],
      acceptance_criteria: ['GET /deals with pagination and filters', 'GET /deals/:id with full details', 'GET /deals/stats with aggregations', 'GET /opportunities with installer filter', 'Real-time sync with Zoho CRM', 'Stage change timestamps captured'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 5,
    },
    {
      title: 'Calls & Qualifications Endpoints',
      description: 'Build endpoints for Calls and Qualifications data. Integrate with Aircall for call data. Support transcription storage.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '16-24h',
      difficulty: 'medium',
      ai_potential: 'medium',
      ai_assist_description: 'Can generate API integration code and data models',
      tools_needed: ['Node.js', 'PostgreSQL', 'Aircall API'],
      knowledge_areas: ['API Integration', 'Database/SQL', 'External APIs'],
      acceptance_criteria: ['GET /calls with pagination and date filters', 'GET /calls/:id with recording URL', 'Call transcripts stored and searchable', 'GET /qualifications with deal linkage', 'Aircall webhook integration working'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: false,
      order_index: 6,
    },
    {
      title: 'WhatsApp Conversation History',
      description: 'Build endpoints for WhatsApp conversation history. Integrate with Woztell API to pull full message history per deal.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '20-30h',
      difficulty: 'hard',
      ai_potential: 'medium',
      ai_assist_description: 'Can help with data mapping and pagination handling',
      tools_needed: ['Node.js', 'PostgreSQL', 'Woztell API'],
      knowledge_areas: ['API Integration', 'Database/SQL', 'External APIs'],
      acceptance_criteria: ['GET /deals/:id/messages with full history', 'Message direction (inbound/outbound) tracked', 'Timestamps accurate to the second', 'Media attachments referenced', 'Webhook for real-time updates'],
      success_metrics: [],
      risks: ['Woztell API documentation'],
      is_foundational: true,
      is_critical_path: false,
      order_index: 7,
    },
    {
      title: 'Installers & Regions Endpoints',
      description: 'Build endpoints for Installers and Regions data. Include performance metrics, capacity, and geographic coverage.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '12-18h',
      difficulty: 'medium',
      ai_potential: 'high',
      ai_assist_description: 'Can generate CRUD endpoints and relationship models',
      tools_needed: ['Node.js', 'PostgreSQL'],
      knowledge_areas: ['API Integration', 'Database/SQL'],
      acceptance_criteria: ['GET /installers with active/inactive filter', 'GET /installers/:id with regions and metrics', 'GET /regions with postal code coverage', 'Installer capacity and quota tracking', 'Performance metrics per installer'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 8,
    },
    {
      title: 'API Testing & Quality Assurance',
      description: 'Comprehensive testing of all API endpoints. Load testing, security audit, edge case handling. Fix bugs and optimize performance.',
      phase: 'testing',
      owner: 'technology',
      estimated_hours: '16-24h',
      difficulty: 'medium',
      ai_potential: 'high',
      ai_assist_description: 'Can generate test cases, mocks, and load test scripts',
      tools_needed: ['Jest', 'Postman', 'Load testing tools'],
      knowledge_areas: ['API Integration', 'Security/Auth', 'DevOps'],
      acceptance_criteria: ['Unit tests for all endpoints (>80% coverage)', 'Integration tests passing', 'Load test: handles 100 req/s', 'Security audit completed', 'No critical/high bugs', 'Response times <500ms for 95% of requests'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 9,
    },
    {
      title: 'API Documentation & Developer Guide',
      description: 'Create comprehensive API documentation with examples. Build interactive API explorer. Write developer onboarding guide.',
      phase: 'training',
      owner: 'technology',
      estimated_hours: '12-16h',
      difficulty: 'easy',
      ai_potential: 'high',
      ai_assist_description: 'Can generate documentation from OpenAPI spec and code comments',
      tools_needed: ['Swagger/OpenAPI', 'Documentation platform'],
      knowledge_areas: ['Training & Documentation', 'API Integration'],
      acceptance_criteria: ['Interactive API documentation live', 'All endpoints documented with examples', 'Authentication guide complete', 'Error code reference', 'Developer quickstart guide', 'Postman collection published'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 10,
    },
    {
      title: 'Production Deployment & Monitoring',
      description: 'Deploy API to production. Set up monitoring, alerting, and dashboards. Configure backup and disaster recovery.',
      phase: 'rollout',
      owner: 'technology',
      estimated_hours: '8-12h',
      difficulty: 'medium',
      ai_potential: 'medium',
      ai_assist_description: 'Can help with deployment configs and monitoring setup',
      tools_needed: ['Vercel/Railway', 'Monitoring tools', 'Alerting'],
      knowledge_areas: ['DevOps', 'Security/Auth'],
      acceptance_criteria: ['API live in production', 'Health check endpoint responding', 'Monitoring dashboard configured', 'Alerts set for errors and latency', 'Database backups scheduled', 'Runbook for incident response'],
      success_metrics: ['99.9% uptime', '<200ms avg response time', 'Zero data loss'],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 11,
    },
    {
      title: 'Ongoing Maintenance & Iteration',
      description: 'Establish ongoing maintenance process. Weekly review of API health, performance optimization, bug fixes, and feature requests.',
      phase: 'monitoring',
      owner: 'technology',
      estimated_hours: 'Ongoing (4h/week)',
      difficulty: 'easy',
      ai_potential: 'medium',
      ai_assist_description: 'Can help analyze logs, identify patterns, and suggest optimizations',
      tools_needed: ['Monitoring tools', 'Issue tracker'],
      knowledge_areas: ['DevOps', 'Stakeholder Management'],
      acceptance_criteria: ['Weekly health review process established', 'SLA monitoring in place', 'Feature request backlog maintained', 'Incident response process documented'],
      success_metrics: ['API health score >95%', 'All critical bugs fixed within 24h'],
      risks: [],
      is_foundational: false,
      is_critical_path: false,
      order_index: 12,
    },
  ],
  'reporting-hub': [
    {
      title: 'KPI Discovery & Stakeholder Alignment',
      description: 'Meet with all department heads to understand reporting needs. Define KPIs, formulas, and success thresholds. Get sign-off on metrics definitions.',
      phase: 'discovery',
      owner: 'operations',
      estimated_hours: '12-16h',
      difficulty: 'medium',
      ai_potential: 'medium',
      ai_assist_description: 'Can suggest industry-standard KPIs and help document formulas',
      tools_needed: ['Meeting tools', 'Notion', 'Spreadsheets'],
      knowledge_areas: ['Stakeholder Management', 'Data Analytics', 'Business Logic'],
      acceptance_criteria: ['KPI catalog with definitions approved by stakeholders', 'Formulas documented and validated', 'Thresholds defined (good/warning/critical)', 'Data sources identified for each KPI', 'Reporting frequency agreed (real-time, daily, weekly)'],
      success_metrics: [],
      risks: ['Conflicting priorities between departments', 'Undefined metrics'],
      is_foundational: false,
      is_critical_path: true,
      order_index: 0,
    },
    {
      title: 'Current State Analysis',
      description: 'Audit existing reports and dashboards. Identify manual reporting processes that can be automated. Document pain points and gaps.',
      phase: 'discovery',
      owner: 'operations',
      estimated_hours: '8-12h',
      difficulty: 'easy',
      ai_potential: 'medium',
      ai_assist_description: 'Can help analyze and categorize existing reports',
      tools_needed: ['Existing tools', 'Documentation'],
      knowledge_areas: ['Data Analytics', 'Process Design'],
      acceptance_criteria: ['Inventory of all existing reports', 'Time spent on manual reporting quantified', 'Pain points documented', 'Automation opportunities identified'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: false,
      order_index: 1,
    },
    {
      title: 'Dashboard Design & Wireframes',
      description: 'Design dashboard layouts, information hierarchy, and user flows. Create wireframes for each stakeholder view. Get design approval.',
      phase: 'planning',
      owner: 'product',
      estimated_hours: '12-16h',
      difficulty: 'medium',
      ai_potential: 'medium',
      ai_assist_description: 'Can suggest dashboard layouts and best practices',
      tools_needed: ['Figma', 'Wireframing tools'],
      knowledge_areas: ['UX Design', 'Data Analytics'],
      acceptance_criteria: ['Wireframes for executive dashboard', 'Wireframes for department-specific views', 'Mobile-responsive design considered', 'Design approved by key stakeholders'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: false,
      order_index: 2,
    },
    {
      title: 'Data Pipeline Architecture',
      description: 'Design data pipeline for KPI calculations. Define aggregation schedules, caching strategy, and historical data retention.',
      phase: 'planning',
      owner: 'technology',
      estimated_hours: '8-12h',
      difficulty: 'hard',
      ai_potential: 'high',
      ai_assist_description: 'Can help design data models and aggregation logic',
      tools_needed: ['Architecture tools', 'Documentation'],
      knowledge_areas: ['Database/SQL', 'Data Analytics', 'DevOps'],
      acceptance_criteria: ['Data pipeline architecture documented', 'Aggregation schedules defined', 'Caching strategy for real-time KPIs', 'Historical data retention policy', 'API endpoints defined for dashboard'],
      success_metrics: [],
      risks: [],
      is_foundational: true,
      is_critical_path: true,
      order_index: 3,
    },
    {
      title: 'KPI Calculation Engine',
      description: 'Build backend service for computing KPIs. Implement aggregations, calculations, and caching. Create API endpoints for dashboard.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '24-32h',
      difficulty: 'hard',
      ai_potential: 'high',
      ai_assist_description: 'Can generate SQL queries, aggregation logic, and API handlers',
      tools_needed: ['Node.js', 'PostgreSQL', 'Redis'],
      knowledge_areas: ['Database/SQL', 'Data Analytics', 'API Integration'],
      acceptance_criteria: ['All KPIs calculating correctly', 'Real-time KPIs updating within 5 seconds', 'Historical snapshots stored daily', 'API endpoints returning correct data', 'Performance: calculations complete in <2s'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 4,
    },
    {
      title: 'Dashboard Frontend Development',
      description: 'Build React dashboard with charts, tables, and filters. Implement responsive design and real-time updates.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '32-40h',
      difficulty: 'medium',
      ai_potential: 'high',
      ai_assist_description: 'Can generate chart components, layouts, and styling',
      tools_needed: ['React', 'Recharts/Chart.js', 'Tailwind'],
      knowledge_areas: ['Frontend/React', 'UX Design', 'Data Analytics'],
      acceptance_criteria: ['Executive dashboard complete', 'Department views implemented', 'Charts rendering correctly', 'Filters and date ranges working', 'Mobile responsive', 'Real-time updates functioning'],
      success_metrics: [],
      risks: [],
      is_foundational: true,
      is_critical_path: true,
      order_index: 5,
    },
    {
      title: 'Export & Scheduling Features',
      description: 'Add PDF/Excel export functionality. Implement scheduled email reports with customizable frequency.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '12-16h',
      difficulty: 'medium',
      ai_potential: 'high',
      ai_assist_description: 'Can generate PDF templates and scheduling logic',
      tools_needed: ['React-PDF', 'Node-cron', 'SendGrid'],
      knowledge_areas: ['Frontend/React', 'DevOps', 'API Integration'],
      acceptance_criteria: ['PDF export working for all dashboards', 'Excel export with proper formatting', 'Scheduled reports configurable', 'Email delivery reliable'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: false,
      order_index: 6,
    },
    {
      title: 'Data Validation & UAT',
      description: 'Validate KPI calculations against manual calculations. Conduct user acceptance testing with stakeholders. Fix discrepancies.',
      phase: 'testing',
      owner: 'operations',
      estimated_hours: '16-24h',
      difficulty: 'medium',
      ai_potential: 'medium',
      ai_assist_description: 'Can help generate test cases and validation scripts',
      tools_needed: ['Spreadsheets', 'Testing tools'],
      knowledge_areas: ['Data Analytics', 'Business Logic'],
      acceptance_criteria: ['All KPIs validated against source data', 'Finance sign-off on financial metrics', 'Sales sign-off on pipeline metrics', 'No calculation discrepancies', 'UAT sign-off from all stakeholders'],
      success_metrics: [],
      risks: ['Discrepancies between systems', 'Stakeholder availability for UAT'],
      is_foundational: false,
      is_critical_path: true,
      order_index: 7,
    },
    {
      title: 'Training & Documentation',
      description: 'Create user guides and video tutorials. Conduct training sessions for each department. Document KPI definitions and interpretations.',
      phase: 'training',
      owner: 'operations',
      estimated_hours: '12-16h',
      difficulty: 'easy',
      ai_potential: 'high',
      ai_assist_description: 'Can generate documentation and training materials',
      tools_needed: ['Documentation', 'Video recording', 'Training tools'],
      knowledge_areas: ['Training & Documentation', 'Change Management'],
      acceptance_criteria: ['User guide published', 'Video tutorials recorded', 'Training sessions completed', 'KPI glossary published', 'FAQ documented'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: false,
      order_index: 8,
    },
    {
      title: 'Production Launch & Adoption',
      description: 'Deploy to production. Announce to company. Monitor adoption and gather feedback. Iterate based on user input.',
      phase: 'rollout',
      owner: 'operations',
      estimated_hours: '8-12h',
      difficulty: 'easy',
      ai_potential: 'low',
      ai_assist_description: 'Human change management required',
      tools_needed: ['Communication tools', 'Analytics'],
      knowledge_areas: ['Change Management', 'Stakeholder Management'],
      acceptance_criteria: ['Dashboard live in production', 'Company announcement sent', 'Adoption tracking in place', 'Feedback channel established', 'First week issues resolved'],
      success_metrics: ['80% of target users accessing weekly', 'Manual reporting time reduced by 60%'],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 9,
    },
  ],
  'sdr-portal': [
    {
      title: 'SDR Workflow Analysis & Pain Points',
      description: 'Shadow SDR team for a full week. Document current workflow, tools used, time spent on each activity. Identify pain points and inefficiencies.',
      phase: 'discovery',
      owner: 'operations',
      estimated_hours: '16-20h',
      difficulty: 'easy',
      ai_potential: 'low',
      ai_assist_description: 'Human observation required for authentic workflow understanding',
      tools_needed: ['Observation', 'Documentation'],
      knowledge_areas: ['Process Design', 'Stakeholder Management'],
      acceptance_criteria: ['Complete SDR workflow documented', 'Time breakdown by activity', 'Pain points ranked by impact', 'Tool usage mapped', 'Improvement opportunities identified'],
      success_metrics: [],
      risks: ['SDR availability', 'Biased self-reporting'],
      is_foundational: false,
      is_critical_path: true,
      order_index: 0,
    },
    {
      title: 'Competitive Tool Analysis',
      description: 'Research competitor SDR tools (Salesloft, Outreach, etc.). Identify best practices and features to incorporate.',
      phase: 'discovery',
      owner: 'product',
      estimated_hours: '8-12h',
      difficulty: 'easy',
      ai_potential: 'high',
      ai_assist_description: 'Can help research and summarize competitor features',
      tools_needed: ['Research', 'Demo accounts'],
      knowledge_areas: ['UX Design', 'Business Logic'],
      acceptance_criteria: ['Competitor feature matrix created', 'Best practices documented', 'Features prioritized for Abeto context'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: false,
      order_index: 1,
    },
    {
      title: 'AI Use Cases Definition',
      description: 'Define specific AI use cases: conversation summaries, prioritization, scripts, objection handling. Get SDR team input on most valuable.',
      phase: 'discovery',
      owner: 'operations',
      estimated_hours: '8-12h',
      difficulty: 'medium',
      ai_potential: 'medium',
      ai_assist_description: 'Can suggest AI use cases and help design prompts',
      tools_needed: ['Workshops', 'Documentation'],
      knowledge_areas: ['LLM/Prompt Engineering', 'Business Logic'],
      acceptance_criteria: ['AI use cases documented with expected impact', 'SDR team buy-in achieved', 'Priority ranking agreed', 'Success metrics defined per use case'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 2,
    },
    {
      title: 'Portal UX Design & Prototyping',
      description: 'Design portal layout, information architecture, and key screens. Create clickable prototype. User test with SDRs.',
      phase: 'planning',
      owner: 'product',
      estimated_hours: '16-24h',
      difficulty: 'medium',
      ai_potential: 'medium',
      ai_assist_description: 'Can suggest layouts and help with design patterns',
      tools_needed: ['Figma', 'Prototyping tools'],
      knowledge_areas: ['UX Design', 'Frontend/React'],
      acceptance_criteria: ['Wireframes for all key screens', 'Clickable prototype created', 'User testing completed with 3+ SDRs', 'Feedback incorporated', 'Final design approved'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 3,
    },
    {
      title: 'Contact Queue & Prioritization',
      description: 'Build smart contact queue with AI prioritization. Show next best contact with reasoning. Implement filters and manual override.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '24-32h',
      difficulty: 'hard',
      ai_potential: 'high',
      ai_assist_description: 'Can help build prioritization algorithm and UI components',
      tools_needed: ['React', 'Node.js', 'PostgreSQL'],
      knowledge_areas: ['Frontend/React', 'API Integration', 'AI/ML'],
      acceptance_criteria: ['Contact queue displays prioritized leads', 'AI reasoning shown for each lead', 'Filters working (region, installer, stage)', 'Manual priority override available', 'Real-time updates from API'],
      success_metrics: ['SDR contact rate +20%'],
      risks: ['AI accuracy concerns'],
      is_foundational: false,
      is_critical_path: true,
      order_index: 4,
    },
    {
      title: 'WhatsApp Summary Integration',
      description: 'Integrate AI-generated conversation summaries. Show key points, sentiment, and suggested talking points for each lead.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '20-28h',
      difficulty: 'hard',
      ai_potential: 'high',
      ai_assist_description: 'Core AI feature - can help with prompt engineering and integration',
      tools_needed: ['Claude/OpenAI API', 'React', 'Node.js'],
      knowledge_areas: ['LLM/Prompt Engineering', 'Frontend/React', 'API Integration'],
      acceptance_criteria: ['Summaries generated for all leads with conversations', 'Key points extracted', 'Sentiment analysis displayed', 'Suggested talking points shown', 'Summary refresh on demand'],
      success_metrics: ['Call prep time reduced by 50%'],
      risks: ['AI accuracy', 'API costs'],
      is_foundational: false,
      is_critical_path: true,
      order_index: 5,
    },
    {
      title: 'Call Logging & Outcome Tracking',
      description: 'Build call logging interface with quick outcome selection. Integrate with Aircall for automatic call duration tracking.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '16-24h',
      difficulty: 'medium',
      ai_potential: 'medium',
      ai_assist_description: 'Can help build forms and Aircall integration',
      tools_needed: ['React', 'Aircall API', 'Zoho API'],
      knowledge_areas: ['Frontend/React', 'API Integration'],
      acceptance_criteria: ['Quick outcome logging (1-click)', 'Notes field with auto-save', 'Call duration auto-populated', 'Next action scheduling', 'Sync to Zoho CRM'],
      success_metrics: ['100% call outcome capture'],
      risks: [],
      is_foundational: false,
      is_critical_path: false,
      order_index: 6,
    },
    {
      title: 'Performance Dashboard',
      description: 'Build SDR performance dashboard showing daily/weekly metrics, leaderboard, and goal progress.',
      phase: 'development',
      owner: 'technology',
      estimated_hours: '16-20h',
      difficulty: 'medium',
      ai_potential: 'high',
      ai_assist_description: 'Can help build chart components and metrics calculations',
      tools_needed: ['React', 'Recharts', 'PostgreSQL'],
      knowledge_areas: ['Frontend/React', 'Data Analytics'],
      acceptance_criteria: ['Daily metrics displayed', 'Weekly trends visible', 'Goal progress tracking', 'Team leaderboard', 'Personal performance history'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: false,
      order_index: 7,
    },
    {
      title: 'Portal Testing & QA',
      description: 'Comprehensive testing of all portal features. Performance testing, mobile responsiveness, edge case handling.',
      phase: 'testing',
      owner: 'technology',
      estimated_hours: '12-16h',
      difficulty: 'medium',
      ai_potential: 'medium',
      ai_assist_description: 'Can help generate test cases',
      tools_needed: ['Testing tools', 'Mobile devices'],
      knowledge_areas: ['Frontend/React', 'DevOps'],
      acceptance_criteria: ['All features tested', 'Mobile responsive', 'Performance acceptable (<2s load)', 'Edge cases handled', 'No critical bugs'],
      success_metrics: [],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 8,
    },
    {
      title: 'SDR Training & Onboarding',
      description: 'Create training materials. Conduct hands-on training with SDR team. Gather initial feedback and iterate.',
      phase: 'training',
      owner: 'operations',
      estimated_hours: '12-16h',
      difficulty: 'easy',
      ai_potential: 'medium',
      ai_assist_description: 'Can help create training materials',
      tools_needed: ['Training tools', 'Video recording'],
      knowledge_areas: ['Training & Documentation', 'Change Management'],
      acceptance_criteria: ['Training guide complete', 'All SDRs trained', 'FAQ documented', 'Feedback collected', 'Quick reference card created'],
      success_metrics: ['100% SDR adoption'],
      risks: ['Resistance to change'],
      is_foundational: false,
      is_critical_path: true,
      order_index: 9,
    },
    {
      title: 'Production Launch & Monitoring',
      description: 'Deploy to production. Roll out to SDR team. Monitor usage and performance. Address issues quickly.',
      phase: 'rollout',
      owner: 'operations',
      estimated_hours: '8-12h',
      difficulty: 'easy',
      ai_potential: 'low',
      ai_assist_description: 'Human change management required',
      tools_needed: ['Deployment tools', 'Analytics'],
      knowledge_areas: ['Change Management', 'DevOps'],
      acceptance_criteria: ['Portal live in production', 'All SDRs have access', 'Usage tracking active', 'Support channel established', 'First week issues resolved'],
      success_metrics: ['90% daily active usage'],
      risks: [],
      is_foundational: false,
      is_critical_path: true,
      order_index: 10,
    },
  ],
};

async function seedTasks() {
  console.log('Fetching projects and teams...');

  // Get projects
  const { data: projects, error: projectsError } = await supabase
    .from('projects')
    .select('id, slug');

  if (projectsError) {
    console.error('Error fetching projects:', projectsError);
    return;
  }

  // Get teams
  const { data: teams, error: teamsError } = await supabase
    .from('teams')
    .select('id, slug');

  if (teamsError) {
    console.error('Error fetching teams:', teamsError);
    return;
  }

  const projectMap = {};
  projects.forEach(p => { projectMap[p.slug] = p.id; });

  const teamMap = {};
  teams.forEach(t => { teamMap[t.slug] = t.id; });

  console.log(`Found ${projects.length} projects and ${teams.length} teams`);

  // First, delete existing tasks
  console.log('Clearing existing tasks...');
  const { error: deleteError } = await supabase
    .from('tasks')
    .delete()
    .neq('id', '00000000-0000-0000-0000-000000000000');

  if (deleteError) {
    console.error('Error deleting tasks:', deleteError.message);
  }

  let totalTasks = 0;
  let successCount = 0;

  for (const [projectSlug, tasks] of Object.entries(allProjectTasks)) {
    const projectId = projectMap[projectSlug];
    if (!projectId) {
      console.log(`Project not found: ${projectSlug}`);
      continue;
    }

    console.log(`\nInserting tasks for ${projectSlug}...`);

    for (const task of tasks) {
      totalTasks++;
      const teamId = teamMap[task.owner];

      const taskData = {
        project_id: projectId,
        title: task.title,
        description: task.description,
        phase: task.phase,
        status: 'not_started',
        difficulty: task.difficulty,
        owner_team_id: teamId,
        estimated_hours: task.estimated_hours,
        ai_potential: task.ai_potential,
        ai_assist_description: task.ai_assist_description,
        tools_needed: task.tools_needed,
        knowledge_areas: task.knowledge_areas,
        acceptance_criteria: task.acceptance_criteria,
        success_metrics: task.success_metrics,
        risks: task.risks,
        is_foundational: task.is_foundational,
        is_critical_path: task.is_critical_path,
        order_index: task.order_index,
      };

      const { error } = await supabase
        .from('tasks')
        .insert(taskData);

      if (error) {
        console.error(`  Error inserting "${task.title}": ${error.message}`);
      } else {
        successCount++;
        process.stdout.write('.');
      }
    }
  }

  console.log(`\n\nInserted ${successCount} of ${totalTasks} tasks`);

  // Verify
  const { data: allTasks } = await supabase
    .from('tasks')
    .select('id, title, project_id');

  console.log(`Total tasks in database: ${allTasks?.length || 0}`);

  // Show tasks per project
  const taskCounts = {};
  allTasks?.forEach(t => {
    const proj = projects.find(p => p.id === t.project_id);
    if (proj) {
      taskCounts[proj.slug] = (taskCounts[proj.slug] || 0) + 1;
    }
  });

  console.log('\nTasks per project:');
  Object.entries(taskCounts).forEach(([slug, count]) => {
    console.log(`  ${slug}: ${count} tasks`);
  });
}

seedTasks();
